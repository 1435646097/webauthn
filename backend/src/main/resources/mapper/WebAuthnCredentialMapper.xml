<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.webauthn.mapper.WebAuthnCredentialMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.example.webauthn.entity.WebAuthnCredentialEntity">
        <id column="Id" property="id" jdbcType="INTEGER"/>
        <result column="UserId" property="userId" jdbcType="INTEGER"/>
        <result column="UserHandle" property="userHandle" jdbcType="VARCHAR"/>
        <result column="CredentialId" property="credentialId" jdbcType="VARCHAR"/>
        <result column="PublicKeyCose" property="publicKeyCose" jdbcType="VARCHAR"/>
        <result column="SignatureCount" property="signatureCount" jdbcType="BIGINT"/>
        <result column="CreateTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="LastUsedTime" property="lastUsedTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        Id, UserId, UserHandle, CredentialId, PublicKeyCose, SignatureCount, CreateTime, LastUsedTime
    </sql>

    <!-- 根据用户 ID 查询用户句柄 -->
    <select id="selectUserHandleByUserId" resultType="java.lang.String">
        SELECT UserHandle
        FROM tbl_webauthn_credential
        WHERE UserId = #{userId}
        LIMIT 1
    </select>

    <!-- 根据用户句柄查询用户 ID -->
    <select id="selectUserIdByUserHandle" resultType="java.lang.Integer">
        SELECT UserId
        FROM tbl_webauthn_credential
        WHERE UserHandle = #{userHandle}
        LIMIT 1
    </select>

    <!-- 插入新的凭证记录 -->
    <insert id="insert" parameterType="com.example.webauthn.entity.WebAuthnCredentialEntity"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tbl_webauthn_credential (
            UserId,
            UserHandle,
            CredentialId,
            PublicKeyCose,
            SignatureCount,
            CreateTime,
            LastUsedTime
        ) VALUES (
            #{userId},
            #{userHandle},
            #{credentialId},
            #{publicKeyCose},
            #{signatureCount},
            #{createTime},
            #{lastUsedTime}
        )
    </insert>

    <!-- 更新凭证的签名计数器和最后使用时间 -->
    <update id="updateSignatureCount">
        UPDATE tbl_webauthn_credential
        SET SignatureCount = #{signatureCount},
            LastUsedTime = #{lastUsedTime}
        WHERE UserId = #{userId}
          AND CredentialId = #{credentialId}
    </update>

    <!-- 根据用户 ID 查询该用户的所有凭证 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tbl_webauthn_credential
        WHERE UserId = #{userId}
        ORDER BY CreateTime DESC
    </select>

    <!-- 根据凭证 ID 查询凭证 -->
    <select id="selectByCredentialId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tbl_webauthn_credential
        WHERE CredentialId = #{credentialId}
        LIMIT 1
    </select>

    <!-- 根据凭证 ID 和用户句柄查询凭证 -->
    <select id="selectByCredentialIdAndUserHandle" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tbl_webauthn_credential
        WHERE CredentialId = #{credentialId}
          AND UserHandle = #{userHandle}
        LIMIT 1
    </select>

    <!-- 根据凭证 ID 查询所有匹配的凭证 -->
    <select id="selectAllByCredentialId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tbl_webauthn_credential
        WHERE CredentialId = #{credentialId}
    </select>

</mapper>
